<!doctype html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>EXODUS â€” ê°ˆë¼ì§„ ë°”ë‹¤ (Legacy Safe)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/htm@3.1.1/dist/htm.umd.js" crossorigin></script>
    <style>
      html,body,#root { height: 100%; }
      body { margin:0; background:#0b0a07; }
      #error-overlay { position: fixed; inset: 0; display:none; padding:16px; background: rgba(0,0,0,0.9); color:#fff; z-index:99999; overflow:auto; }
      #error-overlay pre { white-space: pre-wrap; }
    </style>
  </head>
  <body>
    <div id="root"></div>
    <div id="error-overlay"><div class="max-w-3xl mx-auto">
      <h2 class="text-red-400 text-xl font-bold mb-2">âš ï¸ ëŸ°íƒ€ì„ ì˜¤ë¥˜</h2>
      <pre id="error-text" class="text-sm"></pre>
    </div></div>

    <script>
      (function(){
        function show(msg){
          var o=document.getElementById('error-overlay'), t=document.getElementById('error-text');
          if(o&&t){ t.textContent=String(msg||'Unknown error'); o.style.display='block'; }
        }
        window.addEventListener('error',function(e){ show((e.error&&e.error.stack)||e.message||e.filename+':'+e.lineno); });
        window.addEventListener('unhandledrejection',function(e){ show((e.reason&&e.reason.stack)||String(e.reason)); });
      })();
    </script>

    <script>
      var h = React.createElement;
      var html = htm.bind(h);

      function clamp(n, min, max){
        if(min==null) min=0; if(max==null) max=100;
        return Math.max(min, Math.min(max, n));
      }
      function rnd(min, max){
        return Math.floor(Math.random()*(max-min+1))+min;
      }

      var DIFFICULTY_KEYS = ["ì‰¬ì›€","ë³´í†µ","ì–´ë ¤ì›€","ì•…ëª½"];
      var DIFF_PRESETS = {
        "ì‰¬ì›€": { desc:"ìì› ë„‰ë„‰, ì‚¬ê±´ ì™„í™”, ìë™ ì „ì§„ 1",
          init:{ bread:8, herbs:5, bandage:4, people:220, stress:12, chase:15, maxDistance:10 },
          mods:{ baseChaseGain:4, stressGainPerTurn:2, eventMul:0.8, autoAdvance:1 },
          deckDelta:function(ids){ return [ids.prayer, ids.hide]; }
        },
        "ë³´í†µ": { desc:"ê¸°ë³¸ ë°¸ëŸ°ìŠ¤",
          init:{ bread:6, herbs:4, bandage:3, people:200, stress:15, chase:20, maxDistance:10 },
          mods:{ baseChaseGain:5, stressGainPerTurn:3, eventMul:1.0, autoAdvance:1 }
        },
        "ì–´ë ¤ì›€": { desc:"ì‚¬ê±´â†‘, ì¶”ê²© ê°€ì†â†‘, ìë™ ì „ì§„ 1",
          init:{ bread:5, herbs:3, bandage:2, people:190, stress:18, chase:25, maxDistance:11 },
          mods:{ baseChaseGain:6, stressGainPerTurn:4, eventMul:1.2, autoAdvance:1 }
        },
        "ì•…ëª½": { desc:"ì‚¬ê±´â†‘â†‘, ì¶”ê²© ê°€ì†â†‘â†‘, ìë™ ì „ì§„ 0",
          init:{ bread:4, herbs:2, bandage:2, people:180, stress:20, chase:28, maxDistance:12 },
          mods:{ baseChaseGain:7, stressGainPerTurn:5, eventMul:1.4, autoAdvance:0 }
        }
      };

      var autoId = 0;
      function cid(){ return "C"+(autoId++); }

      function logPrepend(log, msg){
        var out = [msg];
        for(var i=0;i<log.length;i++) out.push(log[i]);
        return out;
      }

      function createCards(){
        var c = {};
        function add(card){
          var id = cid();
          var copy = {};
          for (var k in card) if (Object.prototype.hasOwnProperty.call(card,k)) copy[k]=card[k];
          copy.id = id;
          c[id] = copy;
          return id;
        }
        var bread = add({ name:"ëˆ„ë£© ì—†ëŠ” ë¹µ ë°°ê¸‰", cost:1, tint:"amber-400", text:"ë¹µ -1 âœ ìŠ¤íŠ¸ë ˆìŠ¤ -8, êµ¶ì£¼ë¦¼ ì‚¬ê±´ í™•ë¥ â†“",
          canUse:function(s){ return s.bread>0; },
          use:function(s){ return assignObj(s,{ bread:s.bread-1, stress:clamp(s.stress-8), log:logPrepend(s.log,"ë¹µì„ ë°°ê¸‰í–ˆìŠµë‹ˆë‹¤. ìŠ¤íŠ¸ë ˆìŠ¤ê°€ ì¤„ì—ˆìŠµë‹ˆë‹¤.") }); }
        });
        var herb  = add({ name:"ì•½ì´ˆ ì¹˜ë£Œ", cost:1, tint:"emerald-400", text:"ì•½ì´ˆ -1 âœ ì§ˆë³‘/ë¶€ìƒ í”¼í•´ ì™„í™”, ìŠ¤íŠ¸ë ˆìŠ¤ -4",
          canUse:function(s){ return s.herbs>0; },
          use:function(s){ return assignObj(s,{ herbs:s.herbs-1, stress:clamp(s.stress-4), log:logPrepend(s.log,"ì•½ì´ˆë¡œ ì¹˜ë£Œí–ˆìŠµë‹ˆë‹¤. í”¼í•´ê°€ ì¤„ì–´ë“­ë‹ˆë‹¤.") }); }
        });
        var band  = add({ name:"ë¶•ëŒ€ ê°ê¸°", cost:1, tint:"rose-300", text:"ë¶•ëŒ€ -1 âœ ë¶€ìƒ ì‚¬ë§ ë°©ì§€, ìŠ¤íŠ¸ë ˆìŠ¤ -3",
          canUse:function(s){ return s.bandage>0; },
          use:function(s){ return assignObj(s,{ bandage:s.bandage-1, stress:clamp(s.stress-3), log:logPrepend(s.log,"ë¶•ëŒ€ë¥¼ ì‚¬ìš©í–ˆìŠµë‹ˆë‹¤. ë¶€ìƒì íšŒë³µì— ë„ì›€.") }); }
        });
        var decoy = add({ name:"ë¯¸ë¼ ì‘ì „", cost:1, tint:"yellow-300", text:"ì¶”ê²© -10 (ìµœì†Œ 0)",
          use:function(s){ return assignObj(s,{ chase:clamp(s.chase-10), log:logPrepend(s.log,"ë¯¸ë¼ë¥¼ ì‚¬ìš©í•´ ì¶”ê²©ì„ ë”°ëŒë ¸ìŠµë‹ˆë‹¤.") }); }
        });
        var scout = add({ name:"ì„ ë°œëŒ€ ì •ì°°", cost:1, tint:"sky-300", text:"ì¶”ê²© -5, ìŠ¤íŠ¸ë ˆìŠ¤ -5",
          use:function(s){ return assignObj(s,{ chase:clamp(s.chase-5), stress:clamp(s.stress-5), log:logPrepend(s.log,"ì •ì°° ì„±ê³µ! ì•ˆì „ ê²½ë¡œë¥¼ ë°œê²¬í–ˆìŠµë‹ˆë‹¤.") }); }
        });
        var night = add({ name:"ì•¼ê°„ ì´ë™", cost:1, tint:"indigo-300", text:"ì¶”ê²© -6, ìŠ¤íŠ¸ë ˆìŠ¤ +4",
          use:function(s){ return assignObj(s,{ chase:clamp(s.chase-6), stress:clamp(s.stress+4), log:logPrepend(s.log,"ë°¤ì„ í‹ˆíƒ€ ì´ë™í–ˆìŠµë‹ˆë‹¤. ì¶”ê²©ì´ ì¤„ì—ˆìŠµë‹ˆë‹¤(í”¼ë¡œâ†‘).") }); }
        });
        var march = add({ name:"ë¹ ë¥¸ í–‰êµ°", cost:2, tint:"orange-300", text:"ê±°ë¦¬ +1, ìŠ¤íŠ¸ë ˆìŠ¤ +6, ì¶”ê²© +4",
          use:function(s){ return assignObj(s,{ distance:clamp(s.distance+1,0,s.maxDistance), stress:clamp(s.stress+6), chase:clamp(s.chase+4), log:logPrepend(s.log,"ë¹ ë¥¸ í–‰êµ°ìœ¼ë¡œ ë” ì „ì§„í–ˆìŠµë‹ˆë‹¤.") }); }
        });
        var hide  = add({ name:"ëª¨ë˜ì–¸ë• ì€ë‹‰", cost:1, tint:"amber-500", text:"ì¶”ê²© -8, ì—ë„ˆì§€ +1(ìµœëŒ€ ì´ˆê³¼ ë¶ˆê°€)",
          use:function(s){ return assignObj(s,{ chase:clamp(s.chase-8), energy:clamp(s.energy+1,0,s.maxEnergy), log:logPrepend(s.log,"ëª¨ë˜ì–¸ë•ì— ìˆ¨ì—ˆìŠµë‹ˆë‹¤. ìˆ¨ ê³ ë¥´ê¸°!") }); }
        });
        var prayer= add({ name:"ê¸°ë„", cost:1, tint:"cyan-300", text:"ìŠ¤íŠ¸ë ˆìŠ¤ -10 (ìµœì†Œ 0)",
          use:function(s){ return assignObj(s,{ stress:clamp(s.stress-10), log:logPrepend(s.log,"ê¸°ë„ë¡œ ë§ˆìŒì´ í‰ì•ˆí•´ì¡ŒìŠµë‹ˆë‹¤.") }); }
        });
        var inspire= add({ name:"ê²©ë ¤", cost:0, tint:"emerald-300", text:"ìŠ¤íŠ¸ë ˆìŠ¤ -4",
          use:function(s){ return assignObj(s,{ stress:clamp(s.stress-4), log:logPrepend(s.log,"ê²©ë ¤ì˜ ë§ì´ ë°±ì„±ë“¤ì—ê²Œ í˜ì´ ë˜ì—ˆìŠµë‹ˆë‹¤.") }); }
        });
        return { cards:c, ids:{ bread:bread, herb:herb, band:band, decoy:decoy, scout:scout, night:night, march:march, hide:hide, prayer:prayer, inspire:inspire } };
      }

      function buildStartDeck(ids, diffKey){
        var base=[ ids.bread, ids.bread, ids.herb, ids.band, ids.decoy, ids.scout, ids.night, ids.march, ids.march, ids.hide, ids.prayer, ids.inspire, ids.inspire ];
        var delta=(DIFF_PRESETS[diffKey] && DIFF_PRESETS[diffKey].deckDelta) ? DIFF_PRESETS[diffKey].deckDelta(ids) : [];
        return base.concat(delta);
      }

      function shuffle(arr){
        var a=arr.slice();
        for(var i=a.length-1;i>0;i--){
          var j=Math.floor(Math.random()*(i+1));
          var t=a[i]; a[i]=a[j]; a[j]=t;
        }
        return a;
      }

      function assignObj(s, delta){
        // returns shallow-cloned object with overrides (no spread)
        var out={};
        var k;
        for(k in s) if(Object.prototype.hasOwnProperty.call(s,k)) out[k]=s[k];
        for(k in delta) if(Object.prototype.hasOwnProperty.call(delta,k)) out[k]=delta[k];
        return out;
      }

      function createGame(difficulty){
        var ci = createCards();
        var cards = ci.cards, ids = ci.ids;
        var deck = buildStartDeck(ids, difficulty);
        var draw = shuffle(deck);
        var preset = DIFF_PRESETS[difficulty] || { init:{}, mods:{ baseChaseGain:5, stressGainPerTurn:3, eventMul:1.0, autoAdvance:1 } };
        var init = preset.init || {};
        return {
          turn:1, energy:3, maxEnergy:3,
          deck:deck, discard:[], draw:draw, hand:[], cards:cards,
          bread:(init.bread!=null?init.bread:6),
          herbs:(init.herbs!=null?init.herbs:4),
          bandage:(init.bandage!=null?init.bandage:3),
          people:(init.people!=null?init.people:200),
          lost:0, stress:(init.stress!=null?init.stress:15),
          chase:(init.chase!=null?init.chase:20),
          distance:0, maxDistance:(init.maxDistance!=null?init.maxDistance:10),
          log:["ì¶œë°œ ì¤€ë¹„ê°€ ëë‚¬ìŠµë‹ˆë‹¤. (íƒˆì¶œ ì‹œì‘)"],
          scene:"menu", difficulty:difficulty, mods:preset.mods
        };
      }

      function drawUpTo(s, n){
        if(n==null) n=5;
        var hs = s.hand.slice();
        var dr = s.draw.slice();
        var dc = s.discard.slice();
        var ss = assignObj(s, { hand: hs, draw: dr, discard: dc });
        while (ss.hand.length < n){
          if (ss.draw.length === 0){
            if (ss.discard.length === 0) break;
            ss.draw = shuffle(ss.discard);
            ss.discard = [];
          }
          var id = ss.draw.shift();
          if (id == null) break;
          ss.hand.push(id);
        }
        return ss;
      }

      function startTurn(s){
        s = assignObj(s, { energy: s.maxEnergy, scene: "play" });
        return drawUpTo(s, 5);
      }

      function resolveEndTurnEvents(s){
        var log = s.log.slice();
        var people=s.people, lost=s.lost, stress=s.stress, chase=s.chase, bread=s.bread, herbs=s.herbs, bandage=s.bandage;
        var baseChaseGain = s.mods.baseChaseGain + Math.floor(s.distance/3);
        chase = clamp(chase + baseChaseGain);
        stress = clamp(stress + s.mods.stressGainPerTurn);
        if (bread<=0 && Math.random()<0.4){
          stress = clamp(stress + 8);
          log.unshift("ì‹ëŸ‰ì´ ë¶€ì¡±í•´ ì‚¬ê¸°ê°€ ë–¨ì–´ì¡ŒìŠµë‹ˆë‹¤ (+ìŠ¤íŠ¸ë ˆìŠ¤).");
        }
        var rawChance = 0.15 + stress/200 + chase/300;
        var eventChance = Math.min(rawChance * s.mods.eventMul, 0.6);
        if (Math.random() < eventChance){
          var roll = Math.random();
          if (roll < 0.33){
            var deaths = rnd(1,5);
            if (herbs>0) deaths = Math.max(0, deaths-2);
            if (bandage>0) deaths = Math.max(0, deaths-1);
            people = Math.max(0, people - deaths);
            lost += deaths;
            stress = clamp(stress + 6);
            log.unshift(deaths>0 ? ("ì§ˆë³‘ì´ ëŒì•˜ìŠµë‹ˆë‹¤ (-"+deaths+"ëª…).") : "ì§ˆë³‘ì´ ëŒì•˜ì§€ë§Œ í° í”¼í•´ëŠ” ì—†ì—ˆìŠµë‹ˆë‹¤.");
          } else if (roll < 0.66){
            var leave = rnd(0,4);
            people = Math.max(0, people - leave);
            lost += leave;
            stress = clamp(stress + 5);
            log.unshift(leave>0 ? ("ë‚´ë¶„ì´ ë°œìƒí–ˆìŠµë‹ˆë‹¤ (-"+leave+"ëª… ì´íƒˆ).") : "ì‚¬ì†Œí•œ ë‹¤íˆ¼ì´ ìˆì—ˆì§€ë§Œ ìˆ˜ìŠµí–ˆìŠµë‹ˆë‹¤.");
          } else {
            chase = clamp(chase + rnd(5,12));
            stress = clamp(stress + 4);
            log.unshift("íŒŒë¼ì˜¤ì˜ ë³‘ê±°ê°€ ì†ë„ë¥¼ ëƒ…ë‹ˆë‹¤ (ì¶”ê²©â†‘).");
          }
        }
        var distance = clamp(s.distance + s.mods.autoAdvance, 0, s.maxDistance);
        return assignObj(s, { people:people, lost:lost, stress:stress, chase:chase, bread:bread, herbs:herbs, bandage:bandage, distance:distance, log:log });
      }

      function endTurn(s){
        var ss = assignObj(s, { turn:s.turn+1, energy:s.maxEnergy });
        ss.discard = ss.discard.concat(ss.hand);
        ss.hand = [];
        ss = resolveEndTurnEvents(ss);
        ss = drawUpTo(ss, 5);
        if (ss.chase >= 100 || ss.people <= 0) return assignObj(ss, { scene:"defeat", log: logPrepend(ss.log, "ì´ì§‘íŠ¸ êµ°ëŒ€ì—ê²Œ ì¶”ê²©ë‹¹í–ˆìŠµë‹ˆë‹¤...") });
        if (ss.distance >= ss.maxDistance) return assignObj(ss, { scene:"victory" });
        return ss;
      }

      function playCard(state, id){
        var card = state.cards[id];
        if (!card) return state;
        if (state.energy < card.cost) return state;
        if (card.canUse && !card.canUse(state)) return state;
        var s = assignObj(state, { energy: state.energy - card.cost });
        s = card.use(s);
        var hand = s.hand.slice();
        var idx = hand.indexOf(id);
        if (idx !== -1) hand.splice(idx, 1);
        s.hand = hand;
        s.discard = [id].concat(s.discard);
        return s;
      }

      var TINT_BG = { "amber-400":"bg-amber-400","emerald-400":"bg-emerald-400","rose-300":"bg-rose-300","yellow-300":"bg-yellow-300","sky-300":"bg-sky-300","indigo-300":"bg-indigo-300","orange-300":"bg-orange-300","amber-500":"bg-amber-500","cyan-300":"bg-cyan-300","emerald-300":"bg-emerald-300","amber-300":"bg-amber-300" };

      function Bar(props){
        var label=props.label, val=props.val, max=(props.max!=null?props.max:100), color=props.color;
        var pct = Math.round((val / max) * 100);
        return html`<div class="w-full">
          <div class="flex items-center justify-between text-xs text-amber-100/90">
            <span class="tracking-wider">${label}</span>
            <span class="font-semibold">${val}/${max}</span>
          </div>
          <div class="h-2 w-full rounded-full bg-amber-900/40 overflow-hidden">
            <div class=${"h-2 "+color} style=${{width: pct+"%"}}></div>
          </div>
        </div>`;
      }

      function MeterRow(props){
        var s=props.s;
        return html`<div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-3">
          <div class="flex gap-2 items-center">${Bar({label:"ì¸êµ¬", val:s.people, max:300, color:"bg-amber-300"})}</div>
          <div class="flex gap-2 items-center">${Bar({label:"ìŠ¤íŠ¸ë ˆìŠ¤", val:s.stress, color:"bg-rose-400"})}</div>
          <div class="flex gap-2 items-center">${Bar({label:"ì¶”ê²©", val:s.chase, color:"bg-yellow-300"})}</div>
          <div class="flex gap-2 items-center">${Bar({label:"ê±°ë¦¬", val:s.distance, max:s.maxDistance, color:"bg-orange-400"})}</div>
          <div class="flex gap-2 items-center">${Bar({label:"ì—ë„ˆì§€", val:s.energy, max:s.maxEnergy, color:"bg-emerald-400"})}</div>
        </div>`;
      }

      function ResourcePills(props){
        var s=props.s;
        function pill(label,val,cls){ return html`<div class=${"flex items-center gap-1 px-2 py-1 rounded-full text-xs font-semibold "+cls}>
          <span>${label}</span><span class="opacity-90">${val}</span></div>`; }
        return html`<div class="flex flex-wrap gap-2">
          ${pill("ë¹µ",s.bread,"bg-amber-300/20 text-amber-100 border border-amber-300/30")}
          ${pill("ì•½ì´ˆ",s.herbs,"bg-emerald-300/20 text-emerald-100 border border-emerald-300/30")}
          ${pill("ë¶•ëŒ€",s.bandage,"bg-rose-300/20 text-rose-100 border border-rose-300/30")}
          <div class="flex items-center gap-2 text-amber-100/80 text-xs"><span>í„´</span><span class="font-bold">${s.turn}</span></div>
        </div>`;
      }

      function MapTrack(props){
        var s=props.s;
        var nodes = []; for (var i=0;i<=s.maxDistance;i++) nodes.push(i);
        return html`<div class="flex items-center justify-between gap-2 w-full">
          ${nodes.map(function(i){
            return html`<div class=${"relative w-6 h-6 sm:w-7 sm:h-7 rounded-full flex items-center justify-center text-[10px] sm:text-xs font-bold "+(i<=s.distance?"bg-amber-300 text-amber-950":"bg-amber-950/40 text-amber-100/60")}>${i}
              ${i===s.maxDistance? html`<div class="absolute -top-3 -right-3 text-sky-300">ğŸŒŠ</div>`:null}
            </div>`;
          })}
        </div>`;
      }

      function CardView(props){
        var card=props.card, disabled=props.disabled, onPlay=props.onPlay;
        var tintClass = TINT_BG[card.tint||"amber-300"];
        return html`<button disabled=${disabled} onClick=${onPlay}
          class=${"group relative w-44 h-56 rounded-2xl p-3 text-left shadow-lg bg-amber-950/40 border border-amber-700/40 hover:border-amber-400/50 transition "+(disabled?"opacity-50 cursor-not-allowed":"hover:-translate-y-0.5")}>
          <div class=${"absolute inset-x-0 -top-1 h-1 rounded-t-2xl "+tintClass}></div>
          <div class="text-amber-100 font-bold text-sm pr-8 leading-tight">${card.name}</div>
          <div class="absolute top-3 right-3 w-8 h-8 rounded-full bg-amber-900/60 border border-amber-600/50 flex items-center justify-center text-amber-100 font-extrabold">${card.cost}</div>
          <div class="mt-3 text-[13px] text-amber-100/90 leading-snug">${card.text}</div>
          <div class="absolute bottom-3 left-3 text-[10px] uppercase tracking-wider text-amber-200/60">Action</div>
        </button>`;
      }

      function Log(props){
        var s=props.s;
        return html`<div class="h-40 overflow-auto rounded-xl p-3 bg-amber-950/40 border border-amber-700/40 text-amber-100 text-sm space-y-2">
          ${s.log.map(function(l,i){ return html`<div key=${i} class="opacity-90">â€¢ ${l}</div>`; })}
        </div>`;
      }

      function TopBar(){
        return html`<div class="flex items-center justify-between">
          <div class="text-amber-100 text-xl sm:text-2xl font-extrabold tracking-wide flex items-center gap-2">
            <span>EXODUS</span><span class="text-amber-300/90">/ ê°ˆë¼ì§„ ë°”ë‹¤</span>
          </div>
          <div class="text-amber-200/70 text-xs sm:text-sm">ë±ë¹Œë”© ë¡œê·¸ë¼ì´í¬ ì›¹ê²Œì„ í”„ë¡œí† íƒ€ì…</div>
        </div>`;
      }

      function App(){
        var savedDiff = (typeof window!=="undefined" && localStorage.getItem("exodus_diff")) || "ë³´í†µ";
        var _stateHooks = React.useState(savedDiff);
        var difficulty = _stateHooks[0], setDifficulty = _stateHooks[1];
        var _state2 = React.useState(createGame(savedDiff));
        var state = _state2[0], setState = _state2[1];
        var _state3 = React.useState(null);
        var result = _state3[0], setResult = _state3[1];

        function startGame(){
          var g = createGame(difficulty);
          var s = startTurn(g);
          setState(s);
          setResult(null);
          try{ localStorage.setItem("exodus_diff", difficulty); }catch(e){}
        }

        React.useEffect(function(){
          if(state.scene==="victory"){
            var survivors = state.people;
            var speed = Math.max(0, (12 + (state.difficulty==="ì•…ëª½"?2:0)) - state.turn);
            var safety = 100 - state.chase;
            var morale = 100 - state.stress;
            var score = survivors*2 + speed*100 + safety*5 + morale*3;
            score = Math.max(0, Math.round(score));
            var key="exodus_scores_v1", arr=[];
            try{ arr=JSON.parse(localStorage.getItem(key)||"[]"); }catch(e){}
            arr.push(score); arr.sort(function(a,b){ return b-a; });
            try{ localStorage.setItem(key, JSON.stringify(arr)); }catch(e){}
            var idx=arr.indexOf(score), n=arr.length;
            var percentileTop = Math.round((1 - idx/n)*10000)/100;
            setResult({ score:score, percentile:percentileTop, rank:idx+1, total:n, board:arr.slice(0,10) });
          }
        }, [state.scene]);

        function canPlay(c){ return state.energy>=c.cost && (!c.canUse || c.canUse(state)); }

        var desertBg = "bg-gradient-to-b from-amber-950 via-amber-900 to-amber-800";
        var seaBg = "bg-gradient-to-b from-sky-900 via-sky-700 to-sky-600";

        if(state.scene==="menu"){
          return html`<div class=${"min-h-screen "+desertBg+" p-6 sm:p-8"}>
            <div class="max-w-6xl mx-auto space-y-8">
              ${TopBar()}
              <div class="grid lg:grid-cols-2 gap-8 items-center">
                <div class="space-y-6">
                  <h1 class="text-amber-100 text-3xl sm:text-4xl font-extrabold">ëª¨ì„¸ì™€ í•¨ê»˜ í™í•´ë¡œ</h1>
                  <p class="text-amber-100/90 leading-relaxed">ì´ì§‘íŠ¸ì˜ ì¶”ê²©ì„ í”¼í•´ ë°±ì„±ì„ ì´ëŒê³  í™í•´ê¹Œì§€ ì „ì§„í•˜ì„¸ìš”.</p>
                  <div class="space-y-2">
                    <div class="text-amber-200/80 text-sm">ë‚œì´ë„</div>
                    <div class="flex flex-wrap gap-2">
                      ${DIFFICULTY_KEYS.map(function(k){
                        return html`<button key=${k} onClick=${function(){ setDifficulty(k); }}
                          class=${"px-3 py-2 rounded-xl text-sm border "+(k===difficulty?"bg-amber-300 text-amber-950 border-amber-400":"bg-amber-950/30 text-amber-100 border-amber-700/40 hover:border-amber-400/40")}>${k}</button>`;
                      })}
                    </div>
                    <div class="text-amber-200/70 text-xs">${DIFF_PRESETS[difficulty].desc}</div>
                  </div>
                  <button onClick=${startGame} class="px-5 py-3 rounded-2xl bg-amber-300 text-amber-950 font-extrabold shadow hover:shadow-lg">ì—¬ì • ì‹œì‘</button>
                </div>
                <div class="rounded-3xl border border-amber-700/40 p-6 bg-amber-950/30">
                  <div class="text-amber-200/80 text-sm mb-3">ì‹œì—° ìŠ¤í¬ë¦°ìƒ· (ìƒ˜í”Œ UI)</div>
                  <div class="aspect-video rounded-2xl bg-amber-900/50 flex items-center justify-center">
                    <div class="text-amber-200/70">ì‚¬ë§‰ ìœ„ í–‰ë ¬â€¦ ëª¨ë˜ë°”ëŒâ€¦</div>
                  </div>
                </div>
              </div>
            </div>
          </div>`;
        }

        if(state.scene==="victory"){
          return html`<div class=${"min-h-screen "+seaBg+" p-6 sm:p-8"}>
            <div class="max-w-6xl mx-auto space-y-6">
              <div class="flex items-center justify-between">
                <div class="text-sky-100 text-2xl sm:text-3xl font-extrabold tracking-wide flex items-center gap-2">
                  <span>í™í•´ê°€ ê°ˆë¼ì¡ŒìŠµë‹ˆë‹¤!</span><span>ğŸŒŠ</span>
                </div>
                <button onClick=${startGame} class="px-4 py-2 rounded-xl bg-sky-300 text-sky-950 font-bold">ë‹¤ì‹œ ë„ì „</button>
              </div>
              ${result? html`<div class="text-sky-100 text-sm">ì ìˆ˜: ${result.score} Â· ìƒìœ„ ${result.percentile.toFixed(2)}%</div>`:null}
            </div>
          </div>`;
        }

        if(state.scene==="defeat"){
          return html`<div class=${"min-h-screen "+desertBg+" p-6 sm:p-8"}>
            <div class="max-w-4xl mx-auto space-y-6">
              <div class="text-amber-100 text-2xl sm:text-3xl font-extrabold">íŒ¨ë°°â€¦ ì¶”ê²©ì„ í”¼í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤</div>
              <button onClick=${startGame} class="px-5 py-3 rounded-2xl bg-amber-300 text-amber-950 font-extrabold">ë‹¤ì‹œ ì‹œë„</button>
            </div>
          </div>`;
        }

        return html`<div class=${"min-h-screen "+desertBg+" p-6 sm:p-8"}>
          <div class="max-w-7xl mx-auto space-y-6">
            ${TopBar()}
            <div class="grid lg:grid-cols-3 gap-6">
              <div class="lg:col-span-2 space-y-4">
                ${MeterRow({s:state})}
                ${ResourcePills({s:state})}
                <div class="rounded-3xl p-4 bg-amber-950/30 border border-amber-700/40">
                  <div class="text-amber-200/80 text-sm mb-2">ê²½ë¡œ ì§„í–‰</div>
                  ${MapTrack({s:state})}
                </div>
              </div>
              <div class="space-y-3">
                <div class="rounded-3xl p-4 bg-amber-950/30 border border-amber-700/40">
                  <div class="text-amber-200/80 text-sm mb-2">ì‚¬ê±´ ë¡œê·¸</div>
                  ${Log({s:state})}
                </div>
                <div class="flex gap-3">
                  <button onClick=${function(){ setState(startTurn); }} class="px-4 py-2 rounded-xl bg-amber-300 text-amber-950 font-bold">ì†íŒ¨ ë³´ì¶©</button>
                  <button onClick=${function(){ setState(endTurn); }} class="px-4 py-2 rounded-xl bg-amber-100/90 text-amber-950 font-bold border border-amber-700/40">í„´ ì¢…ë£Œ</button>
                </div>
              </div>
            </div>
            <div class="rounded-3xl p-4 bg-amber-950/30 border border-amber-700/40">
              <div class="text-amber-200/80 text-sm mb-3">ì†íŒ¨ (ì—ë„ˆì§€ ${state.energy}/${state.maxEnergy})</div>
              <div class="flex flex-wrap gap-3">
                ${state.hand.map(function(id, idx){
                  return CardView({ card: state.cards[id], disabled: !(state.energy>=state.cards[id].cost && (!state.cards[id].canUse || state.cards[id].canUse(state))), onPlay: function(){ setState(function(s){ return playCard(s, id); }); } });
                })}
              </div>
              <div class="mt-3 text-amber-200/70 text-xs">ë“œë¡œìš° ${state.draw.length} Â· ë²„ë¦¼ ${state.discard.length}</div>
            </div>
          </div>
        </div>`;
      }

      (function mount(){
        try{
          var rootEl = document.getElementById('root');
          var root = ReactDOM.createRoot(rootEl);
          root.render(html`<${App} />`);
        }catch(e){
          var o=document.getElementById('error-overlay'), t=document.getElementById('error-text');
          if(o&&t){ t.textContent = e.stack || String(e); o.style.display='block'; }
          throw e;
        }
      })();
    </script>
  </body>
</html>
